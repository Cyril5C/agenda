<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Papou Mamine</title>
    <link rel="stylesheet" href="style.css?v=4">
</head>
<body>
    <table>
        <thead>
            <tr id="dates"></tr>
        </thead>
        <tbody>
            <tr id="content"></tr>
        </tbody>
    </table>

    <div class="bottom-section">
        <div class="galerie" id="galerie"></div>
    </div>

    <script>
        // Détecter l'environnement et mettre à jour le titre
        fetch('env.php?t=' + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                if (data.env === 'dev') {
                    document.title = '[DEV] ' + document.title;
                }
            })
            .catch(error => console.error('Erreur chargement environnement:', error));

        const jours = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
        const mois = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];

        const datesRow = document.getElementById('dates');
        const contentRow = document.getElementById('content');

        // Variable pour stocker les événements actuels
        let currentEventsJson = '';

        // Variable globale pour stocker les événements
        let allEvents = [];

        // Fonction pour charger les événements
        function loadEvents() {
            fetch('api.php?t=' + new Date().getTime())
            .then(response => response.json())
            .then(evenements => {
                // Comparer avec les événements actuels pour détecter un changement
                const newEventsJson = JSON.stringify(evenements || []);

                // Toujours recharger les événements car les dates changent chaque jour
                console.log('Événements chargés:', evenements);

                // Sauvegarder les événements pour les réutiliser
                allEvents = evenements;

                // Vider les anciennes données
                datesRow.innerHTML = '';
                contentRow.innerHTML = '';

                // Créer les colonnes pour les 6 jours glissants à partir d'aujourd'hui (+ 2 colonnes d'infos)
                for (let i = 0; i < 6; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() + i);

                    const jour = jours[date.getDay()];
                    const numeroJour = date.getDate();
                    const nomMois = mois[date.getMonth()];

                    // Format de date YYYY-MM-DD pour comparaison
                    const dateStr = date.toISOString().split('T')[0];

                    const th = document.createElement('th');
                    // Ajouter des labels pour aujourd'hui, demain, après-demain
                    if (i === 0) {
                        th.className = 'aujourd-hui';
                        th.innerHTML = `<span class="label-aujourdhui">Aujourd'hui</span><br>${jour}<br>${numeroJour} ${nomMois}`;
                    } else if (i === 1) {
                        th.className = 'demain';
                        th.innerHTML = `<span class="label-demain">Demain</span><br>${jour}<br>${numeroJour} ${nomMois}`;
                    } else if (i === 2) {
                        th.className = 'apres-demain';
                        th.innerHTML = `<span class="label-apres-demain">Après-demain</span><br>${jour}<br>${numeroJour} ${nomMois}`;
                    } else {
                        th.innerHTML = `${jour}<br>${numeroJour} ${nomMois}`;
                    }
                    datesRow.appendChild(th);

                    const td = document.createElement('td');

                    // Collecter tous les événements (dates fixes et récurrents)
                    const eventsForDay = [];

                    // Ajouter les événements avec date fixe
                    evenements
                        .filter(evt => evt.date === dateStr)
                        .forEach(evt => eventsForDay.push(evt));

                    // Ajouter les événements récurrents
                    evenements
                        .filter(evt => evt.recurrent && evt.recurrent.includes(jour))
                        .forEach(evt => {
                            console.log(`Événement récurrent trouvé pour ${jour}:`, evt);
                            eventsForDay.push(evt);
                        });

                    // Trier par heure et afficher
                    eventsForDay
                        .sort((a, b) => a.heure.localeCompare(b.heure))
                        .forEach(evt => {
                            const postit = document.createElement('div');
                            postit.className = 'postit';
                            postit.style.backgroundColor = evt.couleur || '#feff9c';

                            // Ajouter une icône pour les événements récurrents
                            if (evt.recurrent) {
                                const icon = document.createElement('div');
                                icon.className = 'postit-recurrent-icon';
                                icon.textContent = '∞';
                                icon.title = 'Événement récurrent : ' + evt.recurrent.join(', ');
                                postit.appendChild(icon);
                            }

                            const heure = document.createElement('div');
                            heure.className = 'postit-heure';
                            heure.textContent = evt.heure;
                            postit.appendChild(heure);

                            const titre = document.createElement('div');
                            titre.className = 'postit-titre';
                            titre.textContent = evt.titre;
                            postit.appendChild(titre);

                            td.appendChild(postit);
                        });

                    contentRow.appendChild(td);
                }

                // Ajouter l'encart d'informations qui prend 2 colonnes
                const thInfo = document.createElement('th');
                thInfo.colSpan = 2;
                thInfo.className = 'info-header';
                thInfo.innerHTML = 'ℹ️ Informations';
                datesRow.appendChild(thInfo);

                const tdInfo = document.createElement('td');
                tdInfo.colSpan = 2;
                tdInfo.id = 'infosCell';
                tdInfo.className = 'info-cell';
                contentRow.appendChild(tdInfo);
            })
            .catch(error => console.error('Erreur de chargement des événements:', error));
        }

        // Variable pour stocker la liste actuelle des images
        let currentImagesJson = '';

        // Fonction pour charger les images
        function loadImages() {
            fetch('images.php?t=' + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                // Comparer avec les images actuelles pour détecter un changement
                const newImagesJson = JSON.stringify(data.images || []);

                if (newImagesJson === currentImagesJson) {
                    console.log('Aucun changement dans les images');
                    return; // Pas de changement, on ne recharge pas
                }

                currentImagesJson = newImagesJson;
                console.log('Mise à jour des images détectée');

                const galerie = document.getElementById('galerie');
                galerie.innerHTML = ''; // Vider la galerie

                if (!data.success || !data.images || data.images.length === 0) {
                    console.log('Aucune image à afficher');
                    return;
                }

                // Ajouter une classe si une seule image
                if (data.images.length === 1) {
                    galerie.classList.add('galerie-single');
                } else {
                    galerie.classList.remove('galerie-single');
                }

                data.images.forEach(image => {
                    const img = document.createElement('img');
                    img.src = image.url;
                    img.alt = image.titre || 'Image';
                    img.title = image.titre || '';
                    img.onerror = function() {
                        this.style.display = 'none'; // Masquer les images cassées
                    };
                    galerie.appendChild(img);
                });
            })
            .catch(error => console.error('Erreur de chargement des images:', error));
        }

        // Variable pour stocker les infos actuelles
        let currentInfosJson = '';

        // Fonction pour charger les informations diverses
        function loadInfos() {
            fetch('infos.php?t=' + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                // Comparer avec les infos actuelles pour détecter un changement
                const newInfosJson = JSON.stringify(data);

                if (newInfosJson === currentInfosJson) {
                    console.log('Aucun changement dans les infos');
                    return; // Pas de changement, on ne recharge pas
                }

                currentInfosJson = newInfosJson;
                console.log('Mise à jour des infos détectée');

                const infosCell = document.getElementById('infosCell');

                if (infosCell) {
                    let html = '';

                    // Ajouter le texte d'informations s'il existe
                    if (data.success && data.texte && data.texte.trim() !== '') {
                        html += `<div class="infos-texte">${data.texte}</div>`;
                    }

                    // Ajouter les 3 prochains événements après J+6
                    const nextEvents = getNextEvents(3, 6);
                    if (nextEvents.length > 0) {
                        html += '<div class="prochains-events">';
                        html += '<div class="prochains-events-titre">Prochains événements :</div>';
                        nextEvents.forEach(evt => {
                            html += `<div class="prochain-event">`;
                            html += `<span class="event-date">${evt.dateFormatted}</span> - `;
                            html += `<span class="event-heure">${evt.heure}</span> `;
                            html += `<span class="event-titre">${evt.titre}</span>`;
                            html += `</div>`;
                        });
                        html += '</div>';
                    }

                    infosCell.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Erreur de chargement des informations:', error);
                const infosCell = document.getElementById('infosCell');
                if (infosCell) {
                    infosCell.innerHTML = '';
                }
            });
        }

        // Fonction pour récupérer les N prochains événements après X jours
        function getNextEvents(count, afterDays) {
            const events = [];
            const startDate = new Date();
            startDate.setDate(startDate.getDate() + afterDays);

            // Parcourir les 30 prochains jours après J+afterDays
            for (let i = 0; i < 30 && events.length < count; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const jour = jours[date.getDay()];

                // Collecter les événements de ce jour (uniquement les événements avec date fixe, pas les récurrents)
                const dayEvents = [];

                // Événements avec date fixe uniquement (on exclut les récurrents)
                allEvents
                    .filter(evt => evt.date === dateStr && !evt.recurrent)
                    .forEach(evt => dayEvents.push({
                        ...evt,
                        dateFormatted: `${jour} ${date.getDate()} ${mois[date.getMonth()]}`
                    }));

                // Trier par heure et ajouter
                dayEvents
                    .sort((a, b) => a.heure.localeCompare(b.heure))
                    .forEach(evt => {
                        if (events.length < count) {
                            events.push(evt);
                        }
                    });
            }

            return events;
        }

        // Fonction pour tout recharger
        function refreshAll() {
            console.log('Rafraîchissement des données...', new Date().toLocaleTimeString());
            loadEvents();
            loadImages();
            loadInfos();
        }

        // Chargement initial
        refreshAll();

        // Recharger les données toutes les 60 secondes
        setInterval(refreshAll, 60000);
    </script>
</body>
</html>
