<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Papou Mamine</title>
    <link rel="stylesheet" href="style.css?v=3">
</head>
<body>
    <table>
        <thead>
            <tr id="dates"></tr>
        </thead>
        <tbody>
            <tr id="content"></tr>
        </tbody>
    </table>

    <div class="infos-encart" id="infosEncart"></div>

    <div class="galerie" id="galerie"></div>

    <script>
        // Détecter l'environnement et mettre à jour le titre
        fetch('env.php?t=' + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                if (data.env === 'dev') {
                    document.title = '[DEV] ' + document.title;
                }
            })
            .catch(error => console.error('Erreur chargement environnement:', error));

        const jours = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
        const mois = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];

        const datesRow = document.getElementById('dates');
        const contentRow = document.getElementById('content');

        // Fonction pour charger les événements
        function loadEvents() {
            fetch('api.php?t=' + new Date().getTime())
            .then(response => response.json())
            .then(evenements => {
                console.log('Événements chargés:', evenements);

                // Vider les anciennes données
                datesRow.innerHTML = '';
                contentRow.innerHTML = '';

                // Créer les colonnes pour les 8 jours glissants à partir d'aujourd'hui
                for (let i = 0; i < 8; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() + i);

                    const jour = jours[date.getDay()];
                    const numeroJour = date.getDate();
                    const nomMois = mois[date.getMonth()];

                    // Format de date YYYY-MM-DD pour comparaison
                    const dateStr = date.toISOString().split('T')[0];

                    const th = document.createElement('th');
                    // Ajouter des labels pour aujourd'hui, demain, après-demain
                    if (i === 0) {
                        th.className = 'aujourd-hui';
                        th.innerHTML = `<span class="label-aujourdhui">Aujourd'hui</span><br>${jour}<br>${numeroJour} ${nomMois}`;
                    } else if (i === 1) {
                        th.className = 'demain';
                        th.innerHTML = `<span class="label-demain">Demain</span><br>${jour}<br>${numeroJour} ${nomMois}`;
                    } else if (i === 2) {
                        th.className = 'apres-demain';
                        th.innerHTML = `<span class="label-apres-demain">Après-demain</span><br>${jour}<br>${numeroJour} ${nomMois}`;
                    } else {
                        th.innerHTML = `${jour}<br>${numeroJour} ${nomMois}`;
                    }
                    datesRow.appendChild(th);

                    const td = document.createElement('td');

                    // Collecter tous les événements (dates fixes et récurrents)
                    const eventsForDay = [];

                    // Ajouter les événements avec date fixe
                    evenements
                        .filter(evt => evt.date === dateStr)
                        .forEach(evt => eventsForDay.push(evt));

                    // Ajouter les événements récurrents
                    evenements
                        .filter(evt => evt.recurrent && evt.recurrent.includes(jour))
                        .forEach(evt => {
                            console.log(`Événement récurrent trouvé pour ${jour}:`, evt);
                            eventsForDay.push(evt);
                        });

                    // Trier par heure et afficher
                    eventsForDay
                        .sort((a, b) => a.heure.localeCompare(b.heure))
                        .forEach(evt => {
                            const postit = document.createElement('div');
                            postit.className = 'postit';
                            postit.style.backgroundColor = evt.couleur || '#feff9c';

                            // Ajouter une icône pour les événements récurrents
                            if (evt.recurrent) {
                                const icon = document.createElement('div');
                                icon.className = 'postit-recurrent-icon';
                                icon.textContent = '∞';
                                icon.title = 'Événement récurrent : ' + evt.recurrent.join(', ');
                                postit.appendChild(icon);
                            }

                            const heure = document.createElement('div');
                            heure.className = 'postit-heure';
                            heure.textContent = evt.heure;
                            postit.appendChild(heure);

                            const titre = document.createElement('div');
                            titre.className = 'postit-titre';
                            titre.textContent = evt.titre;
                            postit.appendChild(titre);

                            td.appendChild(postit);
                        });

                    contentRow.appendChild(td);
                }
            })
            .catch(error => console.error('Erreur de chargement des événements:', error));
        }

        // Fonction pour charger les images
        function loadImages() {
            fetch('images.php?t=' + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                const galerie = document.getElementById('galerie');
                galerie.innerHTML = ''; // Vider la galerie

                if (!data.success || !data.images || data.images.length === 0) {
                    console.log('Aucune image à afficher');
                    return;
                }

                data.images.forEach(image => {
                    const img = document.createElement('img');
                    // Ajouter un timestamp pour éviter le cache navigateur
                    const separator = image.url.includes('?') ? '&' : '?';
                    img.src = image.url + separator + 't=' + new Date().getTime();
                    img.alt = image.titre || 'Image';
                    img.title = image.titre || '';
                    img.onerror = function() {
                        this.style.display = 'none'; // Masquer les images cassées
                    };
                    galerie.appendChild(img);
                });
            })
            .catch(error => console.error('Erreur de chargement des images:', error));
        }

        // Fonction pour charger les informations diverses
        function loadInfos() {
            fetch('infos.php?t=' + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                const infosEncart = document.getElementById('infosEncart');

                if (data.success && data.texte && data.texte.trim() !== '') {
                    infosEncart.innerHTML = `
                        <div class="infos-titre">ℹ️ Informations</div>
                        <div class="infos-texte">${data.texte}</div>
                    `;
                    infosEncart.style.display = 'block';
                } else {
                    infosEncart.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Erreur de chargement des informations:', error);
                document.getElementById('infosEncart').style.display = 'none';
            });
        }

        // Fonction pour tout recharger
        function refreshAll() {
            console.log('Rafraîchissement des données...', new Date().toLocaleTimeString());
            loadEvents();
            loadImages();
            loadInfos();
        }

        // Chargement initial
        refreshAll();

        // Recharger les données toutes les 60 secondes
        setInterval(refreshAll, 60000);
    </script>
</body>
</html>
